# 手搓无人机-项目总结&经验分享

在今年的九十月份，我和两位伙伴手搓出一架四旋翼无人机（以下简称“飞机”），做这架飞机耗时两三个月，包括硬件、软件、视觉，最后也是把基本的一些功能都可以实现了，比如说遥控飞行、定点定高悬停、自主巡航等等功能。把这些全部做完之后发现，其实做一架只是能飞的飞机并没有之前想象的那么难，当然想做到大疆那种性能的无人机，那还是相当有难度的，大疆的无人机上的各种功能，比如飞机上挂个摄像头但可以拍出那么稳的画面，飞出去几百米甚至多少公里还能结合视觉实现实时路径规划和定位做到一键返航......这还是相当复杂的，本文章不说这些，就说说一个简单的无人机的设计思路，记录一下自己几个月踩的坑并且分享一下经验。

---

## 硬件

这架飞机使用STM32F407VET6做主控，这个芯片168Mhz的主频已经够用了，STM32F4系列芯片的资源也是相当丰富的了，十六个定时器，六个串口，现在的功能是完全可以满足，即使以后加其他东西也够用。最主要的是STM32F4系列上有了FPU(浮点数运算单元)，这个是相当不错的，因为一架飞机上的浮点数运算是很多的，设计一架无人机里最有价值也最有难度的部分就是各种数据的获取、处理与融合，有这个FPU，算小数的速度明显是快了许多的。其实在选择这个F407芯片做主控之前，也用过那片最经典的STM32F103C8T6做过一个半成品小飞机，能用是能用，但对这个芯片压力似乎有点大，偶尔会死机，而且串口实在不够用，就换这片F407了。

然后说飞控板PCB的设计，这个PCB是六层板，画起来难度不算太大，一不走大功率，二不走高速信号，只需要注意一些常见的PCB设计规范即可。首先，这个飞机的imu选的是经典的mpu6050，便宜好用，虽然yaw轴容易漂，但是用些算法处理一些，还是可以接受的，放置它的时候尽可能的把他放在飞控的几何中心的位置，这样测出来的数据才是最准的。然后是这个芯片是QFN封装，不好焊，画的时候可以手动把焊盘拉长一点，这样焊的时候会稍微容易一点。还有晶振，它的周围要放一个禁止铺铜区，一是避免它周围产生寄生电容干扰它，另一点是避免铺铜区给它导热。这个板子引出来好几个串口接口，其中一个是给遥控器用的，用来插遥控器的接收机。遥控器的接收机的通信使用sbus协议，所以板子上串口的rx引脚要硬件取反，一个三极管一个电阻就可以实现了，另外说一下，不要想着软件取反了，真的做不到。其他的，电源的滤波电容，芯片供电的退耦电容，该加要加，它俩都是在防止电平的不稳定，只不过前者是由各种外界噪声引起的，后者是由芯片的瞬时功率突然变化引起的，这是我的理解。

除了上面说的，这个飞控上还包含蜂鸣器，大气压传感器（BMP280），一个oled小屏幕的接口，几个按键，还有一些指示灯。留这个蜂鸣器跟指示灯是为了交互时方便一点的，后面调试时这个蜂鸣器也立了大功，非常好用。至于小屏幕和按键，用来写个菜单啥的方便交互，比如起飞之前可以通过按键和显示屏直接选择模式等等功能，还是相当不错的。然后这个bmp280，它可以测温度和气压，用公式是可以推出当前海拔的，也是一种获取高度的方法，但是用这个要考虑很多，飞起来还会被各种因素干扰，据前辈所说，用它要往上面铺一层膜盖上（我晕），所以最后也没用上。这个板用的东西还是相当常见的，不过也够用了。

---

## 软件

飞控的软件部分基于keil5 MDK开发环境，使用STlink进行烧录和调试。软件部分主要包括飞行器的核心控制代码，主要是利用PID算法实现的，其次是与飞机上其他各传感器的通信和数据获取与处理，还有飞机上各种任务的调度与任务间的通信，这一部分写起来还是费了点心思的，因为之后可能还会需要拿这架飞机做其他的一些任务，所以留出一些接口避免和底层的控制代码、配置代码混合，也是追求软件工程中所讲的“高内聚，低耦合”的思想。

先说控制部分，整个飞机的控制采用串级pid的算法，首先是姿态环，内环角速度环，外环角度环，这两个闭环的参数调好了，飞机就能飞起来了。最开始调这个也是毫无头绪，查了点资料又问了下其他大佬，大致有了点思路，然后就拿了俩椅子中间绑根棍子，把飞机捆上去，开始调参数，调参数的话，数据的可视化也非常重要，能看着详细的曲线调，效率会高很多，我们当时用了个串口无线数传，配合vofa上位机软件，轻易就把数据发出来了，不过这个数传传输速率有点低，我把串口波特率拉高之后，上位机收到的数据明显滞后了很多，最后选了个合适的波特率，就没那么滞后了。接着就是调pid，姿态环经过我们的分析，最后确定是内环角速度环采取pi组合，外环角度环采取pd组合，然后就开始在“烤机架”上调。根据别人的说法，当只有角速度环的话，飞机就能在调试架上稳定住不栽下去，但是我们调了好久，实在做不到，可能我们的飞机结构不好，或者重量问题，或者参数真的没调好，但是给上外环角度环之后，飞机确实就在调试架上立起来了，稳定效果也不错。调完姿态环后就是位置环了，因为光有姿态环是不行的，飞机不可能稳定到到一个地方，会慢慢飘走。